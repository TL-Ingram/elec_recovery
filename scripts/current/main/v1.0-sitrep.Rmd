---
title: "ORMIS data quality summary"
author: "Thomas Ingram"
date: "`r Sys.Date()`"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
shelf(odbc, DBI, tidyverse, lubridate, here, gt, hrbrthemes, tidytext, igraph, ggraph)
```

# Overview of ORMIS data quality 

Initial filter to include only Wrightington Hospital.
Data inspected extends from Jan-1-2020 - Sept-20-2022:
33,918 rows and 171 columns.

<br>

The count of NA cells per column were counted and frequency produced with two prior conditions in mind:

- *NAs due to cancelled sessions do not represent poor data quality.* Data were filtered to only include sessions that were completed. 23,072 rows remaining.

- *The prior delayed session work presented data cleaning issues that would have been solved with improved data quality.* Data quality was assessed with this question in mind.

<br>

Table 1 presents a filtered version of the true picture of data quality across the 171 ORMIS columns. Table 1 shows only those columns (variables) that I believe deserve further attention, and would achieve the greatest returns for improvements to future data analyses. Each of these variables either introduces ambiguity in understanding the variable, or uncertainty in the robustness of the variable and thus all connected variables' data quality.

I will take each of the variables highlighted in Table 1 and explore them in their current state, and make suggestions for their improvement.


```{r sum, include = TRUE, echo = FALSE, warning = FALSE, message = FALSE}
na_sum <- read_rds(here::here("rds", "quality_sum", "overall_na_sum.rds")) %>%
  gt(
    groupname_col = "Subheading",
    rowname_col = "Variable"
  ) %>%
  tab_header(title = md("Table 1"),
             subtitle = md("NA Summary - variables of interest")) %>%
  opt_table_lines(extent = "none") %>%
  tab_style(
    style = list(
      cell_text(weight = "bold")
    ),
    locations = cells_row_groups()
  ) %>%
  opt_table_lines(extent = "default") %>%
  tab_options(
    column_labels.border.top.color = "white",
    column_labels.border.top.width = px(3),
    column_labels.border.bottom.color = "black",
    table_body.hlines.color = "white",
    table.border.bottom.color = "white",
    table.border.bottom.width = px(3)
  )
na_sum


```

---

\newpage

## Procedural delay reason & comments

### Procedural delay reason data quality

Since 2020 ~5% of delayed theatre sessions have not received a delay reason (Table 2). This is a low cost improvement that should be immediately addressed to improve future data analysis confidence.

``` {r delay_reason_sum, include = TRUE, echo = FALSE, warning = FALSE}
delay_reason_sum <- read_rds(here("rds", "quality_sum", "delay_reason_sum.rds")) %>%
    gt(
    groupname_col = "Subheading",
    rowname_col = "Variable"
  ) %>%
  tab_header(title = md("Table 2"),
              subtitle = md("Delayed sessions - frequency of delay reason input")) %>%
  opt_table_lines(extent = "none") %>%
  tab_style(
    style = list(
      cell_text(weight = "bold")
    ),
    locations = cells_row_groups()
  ) %>%
  opt_table_lines(extent = "default") %>%
  tab_options(
    column_labels.border.top.color = "white",
    column_labels.border.top.width = px(3),
    column_labels.border.bottom.color = "black",
    table_body.hlines.color = "white",
    table.border.bottom.color = "white",
    table.border.bottom.width = px(3)
  )
delay_reason_sum
```

In their current state, procedural delay reasons are limited in their utility for meaningful analysis (Figure 1 for a visual representation of the below points):

- *The meaning of the choices of procedural delay reasons are ambiguous, thereby introducing confusion in the appropriate delay reason staff should select.*

- *Many of the procedural delay reasons are broad; they are used by staff to cover disparate delay reasons*

- *39 procedural_delay_reasons have been used since 2020; 27 of these have been used <1% of the total.* Some of the delay reasons are almost the same, potentially introducing uncertainty of correct choice and redundancy of choices (E.g. four separate delay reasons that relate to the patient being late to the ward).

``` {r delay_reason_figure, include = TRUE, echo = FALSE, warning = FALSE}
code_freq <- read_rds(here::here("rds", "quality_sum", "d_code_freq.rds")) %>%
  ggplot(., aes(x = freq, y = reorder(procedural_delay_reason, desc(freq)), fill = 
                  frequency)) +
  geom_col(alpha = 0.6) +
  scale_fill_manual(values = c("blue", "steelblue")) +
  theme_bw() +
  theme(text=element_text(family="serif", size = 8),
        panel.grid.minor=element_blank(),
        panel.grid.major.x=element_blank(),
        panel.grid.major.y=element_blank(),
        axis.title=element_blank(),
        legend.title = element_text(size = 8),
        legend.text = element_text(size = 8),
        axis.text = element_text(size = 8),
        axis.text.y = element_text(colour = c(rep("black", 3), 
                                              "darkred", rep("black", 8), 
                                              "darkred", rep("black", 14), 
                                              "darkred", rep("black", 5), 
                                              "darkred", rep("black", 5))),
        plot.caption = element_text(size = 8),
        title = element_text(size = 11)) +
  labs(x = "%",
       y = "",
       fill = "frequency",
       subtitle = "Procedural delay reason overview",
       title = "Figure 1",
       caption = "Red text distinguishes similar reason codes")
code_freq
```

---

### Procedural delay comment data quality

All delayed theatre sessions that have reason codes also have free-hand comments; however, the majority of comments are poorly constructed and convey little meaning.

15.62% of all comments contain only a single word (Table 3); ~51% contain three or less (Figure 2). 


``` {r eg_one_word_com, include = TRUE, echo = FALSE, warning = FALSE } 
one_word <- read_rds(here("rds", "quality_sum", "eg_one_word_com.rds")) %>%
  gt(
    groupname_col = "Subheading",
    rowname_col = "Variable"
  ) %>%
    tab_header(title = md("Table 3")) %>%
  opt_table_lines(extent = "none") %>%
  tab_style(
    style = list(
      cell_text(weight = "bold")
    ),
    locations = cells_row_groups()
  ) %>%
  cols_align(align = "center"
  ) %>%
  opt_table_lines(extent = "default") %>%
  tab_options(
    column_labels.border.top.color = "white",
    column_labels.border.top.width = px(3),
    column_labels.border.bottom.color = "black",
    table_body.hlines.color = "white",
    table.border.bottom.color = "white",
    table.border.bottom.width = px(3)
  )
one_word
```

``` {r num_words, include = TRUE, echo = FALSE, warning = FALSE}
num_words <- read_rds(here::here("rds", "quality_sum", "delay_comment_sum.rds")) %>%
  ggplot(., aes(x = `number of words`, y = `freq %`)) +
  geom_col(alpha = 0.6, fill = "steelblue") +
  theme_bw() +
  theme(text=element_text(family="serif", size = 8),
        panel.grid.minor=element_blank(),
        panel.grid.major.x=element_blank(),
        panel.grid.major.y=element_blank(),
        legend.title = element_text(size = 8),
        legend.text = element_text(size = 8),
        axis.text = element_text(size = 8),
        plot.caption = element_text(size = 8),
        title = element_text(size = 11)) +
  labs(x = "Word count",
       y = "%",
       fill = "frequency",
       subtitle = "Free-hand comments: word count",
       title = "Figure 2")
num_words
```

- *Improvements to the free-hand text should be addressed with priority.* I propose that the free-hand comments should provide more detailed explanations of the delay reason. For an example, a current comment may state: "surgeon delayed"; A more useful comment would state: "surgeon delayed due to a emergency situation with another patient". In this case the analyst would be able to clearly distinguish this case as an uncontrollable event that should not be included with other "surgeon delay" sub-groups.

- *Many independent free-hand comments are used for one procedural delay reason.* A thorough analysis of free-hand comments should be carried out to assess a list of the most relevant procedural delay reasons. Figure three shows three majority clusters of comments used for the 'Non-Clinical event' reason code. The figure also highlights possible incorrect use of comment reasons: "awaiting surgeon" would appear to be more appropriately placed in the 'surgeon delayed' reason code. However, without truly descriptive comments it is difficult to assess.

``` {r LDA_graph, include = TRUE, echo = FALSE, warning = FALSE}
lda_graph <- read_rds(here::here("rds", "quality_sum", "lda_data.rds")) %>%
  ggraph(layout = "kk") +
  geom_edge_link(aes(edge_alpha = frequency, edge_width = frequency), 
                 edge_colour = "steelblue") +
  geom_node_point(size = 1) +
  scale_edge_width(range = c(1,3)) +
  scale_edge_alpha(range = c(0.25,1)) +
  geom_node_text(aes(label = name), vjust = 1, hjust = 1, size = 3) +
  scale_x_discrete(expand=expansion(mult=c(0.5,0.5))) +
  theme_bw() +
  theme(text=element_text(family="serif", size = 8),
        panel.grid.minor=element_blank(),
        panel.grid.major.x=element_blank(),
        panel.grid.major.y=element_blank(),
        legend.title = element_text(size = 8),
        legend.text = element_text(size = 8),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        plot.caption = element_text(size = 8),
        title = element_text(size = 11)) +
  labs(x = "",
       y = "",
       caption = "Only word linkages contained in >1% of comments are shown. Position of clusters on map is not relevant.",
       title = "Figure 4",
       subtitle = "Thematic analysis of free-hand comment words from 'Non-Clinical event' reason code")
lda_graph
```

---

### Suggestions:

Procedural delay reasons and their free hand comments are vital pieces of information that should be regularly analysed for themes and patterns, which may be addressed and processed improved. The current state of these fields are mixed: there is good adherence to completing the fields (95%), yet there does not appear to be standardisation in how to appropriately complete them. I propose the following suggestions for improvement:

- Filter and define new reason codes, using free-hand comments to assess the most suitable: do not introduce ambiguity or too much breadth.
- Free-hand comments are currently poorly used; 50% contain more than four words. Comments should add flavour to the reason code: if the reason code is "late team brief", the comment should explain the reason why the team brief was late.
- Involve band 7 nursing staff into these discussions to 1) aid defining new reason codes, 2) gauge whether they envision any problems to these changes, 3) aid dissemination of the new practice and importance of data quality to all theatre staff.

---

<!-- \newpage -->

<!-- ## Procedure, anatomical and diagnosis codes -->

<!-- Patient codes are useful for predictive modelling to assess whether there are subgroups of patients that are more or less likely to have theatre session lengths different than expected. Ensuring the accuracy of these observations is therefore critical to enabling this.  -->

<!-- Both anatomical site and anatomical side show particularly high NA proportions (Table 4) - it would be worth investigating whether there are reasons for their neglect. -->

<!-- ``` {r patient_code, include = TRUE, echo = FALSE, warning = FALSE} -->
<!-- patient_code <- read_rds(here("rds", "quality_sum", "patient_codes.rds")) %>% -->
<!--     gt( -->
<!--     groupname_col = "Subheading", -->
<!--     rowname_col = "Variable" -->
<!--   ) %>% -->
<!--   tab_header(title = md("Table 4"), -->
<!--              subtitle = md("NA Summary - variables of interest")) %>% -->
<!--   opt_table_lines(extent = "none") %>% -->
<!--   tab_style( -->
<!--     style = list( -->
<!--       cell_text(weight = "bold") -->
<!--     ), -->
<!--     locations = cells_row_groups() -->
<!--   ) %>% -->
<!--   opt_table_lines(extent = "default") %>% -->
<!--   tab_options( -->
<!--     column_labels.border.top.color = "white", -->
<!--     column_labels.border.top.width = px(3), -->
<!--     column_labels.border.bottom.color = "black", -->
<!--     table_body.hlines.color = "white", -->
<!--     table.border.bottom.color = "white", -->
<!--     table.border.bottom.width = px(3) -->
<!--   ) -->
<!-- patient_code -->
<!-- ``` -->

<!-- --- -->

<!-- \newpage -->

<!-- ## sent_for & porter_time -->

<!-- These two columns ostensibly define the times when the patients were originally sent for, although it is not clear by whom, and the time the porter was sent to receive the patient. These two columns are the first entry time points for the theatre session - their importance is such that they indirectly point toward the time at which the morning team brief was completed. Therefore, the accuracy of these observations is vital, however, currently ~32% and ~81% of observations do not have entries. -->

<!-- ``` {r sent_porter, include = TRUE, echo = FALSE, warning = FALSE} -->
<!-- sent_porter <- read_rds(here("rds", "quality_sum", "sent_porter.rds")) %>% -->
<!--     gt( -->
<!--     groupname_col = "Subheading", -->
<!--     rowname_col = "Variable" -->
<!--   ) %>% -->
<!--   tab_header(title = md("Table 5"), -->
<!--              subtitle = md("NA Summary - variables of interest")) %>% -->
<!--   opt_table_lines(extent = "none") %>% -->
<!--   tab_style( -->
<!--     style = list( -->
<!--       cell_text(weight = "bold") -->
<!--     ), -->
<!--     locations = cells_row_groups() -->
<!--   ) %>% -->
<!--   opt_table_lines(extent = "default") %>% -->
<!--   tab_options( -->
<!--     column_labels.border.top.color = "white", -->
<!--     column_labels.border.top.width = px(3), -->
<!--     column_labels.border.bottom.color = "black", -->
<!--     table_body.hlines.color = "white", -->
<!--     table.border.bottom.color = "white", -->
<!--     table.border.bottom.width = px(3) -->
<!--   ) -->
<!-- sent_porter -->
<!-- ``` -->

<!-- The distinction between these two variables is not clear to me, and the quality of the data suggest I am not alone in this confusion.  -->

